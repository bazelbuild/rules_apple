---
x_defaults:
  # YAML has a feature for "repeated nodes", BazelCI is fine with extra nodes
  # it doesn't know about; so that is used to avoid repeating common subparts.
  common: &common
    platform: macos_arm64
    xcode_version: "16.4"
    shell_commands:
    - xcrun simctl runtime list
    - xcodebuild -downloadPlatform iOS -buildVersion 18.5
    - xcrun simctl runtime match set iphoneos18.5 22F77
    - xcrun simctl runtime list
    - xcrun simctl runtime match list
    post_shell_commands:
    - xcrun simctl runtime match set iphoneos18.5 --default
    - xcrun simctl runtime match list
    build_targets:
    - "tools/..."
    - "test/..."
    build_flags:
    - --modify_execution_info=AssetCatalogCompile=+exclusive
    test_targets:
    - "tools/..."
    - "test/..."
    - "examples/..."
    test_flags:
    - --local_test_jobs=2
    - --modify_execution_info=AssetCatalogCompile=+exclusive
    - --test_tag_filters=-skipci
    - --ios_simulator_device=iPhone 16
    include_json_profile:
      - build
      - test

# NOTE: To avoid listing the same things for build_flags/test_flags for each
# of these tasks, they are listed in the .bazelrc instead.
tasks:
  macos_7.x:
    name: "7.x"
    bazel: 7.x
    <<: *common

  macos_8.x:
    name: "8.x"
    bazel: 8.x
    <<: *common

  # TODO: Re-enable when we fix bazel 9.x
  # macos_last_rc:
  #   name: "Last RC Bazel"
  #   bazel: last_rc
  #   <<: *common

  macos_last_green:
    name: "Last Green Bazel"
    # TODO: Move back to last_green ASAP
    bazel: 9.0.0-pre.20250908.2
    <<: *common

  doc_tests:
    name: "Doc tests"
    # TODO: Move back to last_green once rules_cc is fixed
    bazel: a25f64adff6feabb8c34fdb3a5b36ca569a4c4bb
    platform: ubuntu2004
    test_targets:
    - "doc/..."

buildifier: 8.2.1
