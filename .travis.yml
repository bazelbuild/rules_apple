os: osx
# Not really swift, but stops travis from saying it is ruby.
language: swift

# Travis does not use osx_image when it computes the matrix itself, if we want
# to test on multiple versions, then it required manually building the matrix
# to set a different osx_image for each configuration.
osx_image: xcode9.2

# Build out the matrix ourselves so we can set multiple variables.
# - `BAZEL_VERSION`: Used in `before_install` to pick the version of bazel to
#    use, "HEAD" uses the last good version on ci.bazel.build
# - `TARGET` & `BUILD_TARGET`: Are used in the `script` to issue a build
#   `script` phase will be used for an optional `bazel build` and then
#   `bazel test`.
#
# NOTE: The different testing targets are currently split because //test/...
# takes a long time (>25min), and this will allow other things to pass/fail
# independently and provide a shorter log file to look at when things do fail,
# but if getting all to run take too long it might make sense to merge
# things back together, potentially all the way down to just two configs for
# the two different bazel versions.
matrix:
  include:
    # One build on linux to run buildifer since linux agents are faster on travis.
    - os: linux
      dist: trusty
      sudo: false
      language: cpp
      env: BUILDIFER=RELEASE
    # The normal macOS builds.
    - env: BAZEL=RELEASE TARGET=//tools/...
    - env: BAZEL=RELEASE TARGET=//test/...
    - env: BAZEL=RELEASE BUILD_TARGET=//examples:ci_build_targets TARGET=//examples:ci_test_targets
    - env: BAZEL=HEAD TARGET=//tools/...
    - env: BAZEL=HEAD TARGET=//test/...
    - env: BAZEL=HEAD BUILD_TARGET=//examples:ci_build_targets TARGET=//examples:ci_test_targets

  # There are a few issue to resolve in the current tests, all them to fail.
  allow_failures:
    - env: BAZEL=RELEASE TARGET=//test/...
    - env: BAZEL=HEAD TARGET=//test/...

before_install:
  - ./.travis_install.sh

script:
  - ./.travis_build.sh

notifications:
  email: false

# Don't build the google branch since that is used by the export process and a PR
# will be made after the fact.
branches:
  except:
    - google
